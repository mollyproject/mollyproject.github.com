<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Explaining Molly’s class-based views &mdash; molly v0.3 documentation</title>
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.3',
        COLLAPSE_MODINDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="molly v0.3 documentation" href="../index.html" />
    <link rel="up" title="Implementation topics" href="index.html" />
    <link rel="next" title="Testing" href="testing.html" />
    <link rel="prev" title="Writing an application" href="writing_an_application.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../modindex.html" title="Global Module Index"
             accesskey="M">modules</a> |</li>
        <li class="right" >
          <a href="testing.html" title="Testing"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="writing_an_application.html" title="Writing an application"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">molly v0.3 documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Implementation topics</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="explaining-molly-s-class-based-views">
<h1>Explaining Molly&#8217;s class-based views<a class="headerlink" href="#explaining-molly-s-class-based-views" title="Permalink to this headline">¶</a></h1>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This has been lifted verbatim from <a class="reference external" href="http://blogs.oucs.ox.ac.uk/inapickle/2009/12/15/django-class-based-views-metaclassing-and-view-validation/">a blog post</a>
and still needs to be tidied up to fit the documentation.</p>
</div>
<p>When an HTTP request is handled by a Django website, it attempts to match the
local part of the URL against a series of regular expressions. Upon finding a
match it passes an object representing the request as an argument to a
callable associated with the regular expression. In Python, most callables you
will find are class or instance methods, or functions. The Django
documentation only briefly refers to the fact that one can use callables other
than functions.</p>
<div class="section" id="class-based-views-and-metaclasses">
<h2>Class-based views and metaclasses<a class="headerlink" href="#class-based-views-and-metaclasses" title="Permalink to this headline">¶</a></h2>
<p>We’re using class-based views, a concept that doesn’t seem to have much of a
presence on the Internet. The usual approach is to define a method
<tt class="docutils literal"><span class="pre">__call__(self,</span> <span class="pre">request,</span> <span class="pre">…)</span></tt> on a class, an instance of which is then placed
in an urlconf. Our approach is the following:</p>
<blockquote>
<ul class="simple">
<li>Have a base view called, oddly enough, BaseView.</li>
<li>Define a method __new__(cls, request, …) that despatches to other class
methods depending on the HTTP method.</li>
<li>The __new__ method also calls a method to add common context for each of
the handlers.</li>
<li>We use a metaclass to save having to put &#64;classmethod decorators in front
of every method.</li>
<li>We never create instances of the view classes; instead, __new__ returns an
HttpResponse object and the class itself is place in the urlconf.</li>
</ul>
</blockquote>
<p>Here&#8217;s the code:</p>
<div class="highlight-python"><pre>from inspect import isfunction
from django.template import RequestContext

class ViewMetaclass(type):
     def __new__(cls, name, bases, dict):
         # Wrap all functions but __new__ in a classmethod before
         # constructing the class
         for key, value in dict.items():
             if isfunction(value) and key != '__new__':
                 dict[key] = classmethod(value)
         return type.__new__(cls, name, bases, dict)

class BaseView(object):
    __metaclass__ = ViewMetaclass

    def method_not_acceptable(cls, request):
        """
        Returns a simple 405 response.
        """

        response = HttpResponse(
            'You can't perform a %s request against this resource.' %
                request.method.upper(),
            status=405,
        )
        return response

        # We could go on defining error status handlers, but there's
        # little need. These can also be overridden in subclasses if
        # necessary.

        def initial_context(cls, request, *args, **kwargs):
            """
            Returns common context for each of the HTTP method
            handlers. You will probably want to override this in
            subclasses.
            """

            return {}

        def __new__(cls, request, *args, **kwargs):
            """
            Takes a request and arguments from the URL despatcher,
            returning an HttpResponse object.
            """

            method_name = 'handle_%s' % request.method
            if hasattr(cls, method_name):
                # Construct the initial context to pass to the HTTP
                # handler
                context = RequestContext(request)
                context.update(cls.initial_context(request,
                                                   *args, **kwargs))

                # getattr returns a staticmethod , which we pass the
                # request and initial context
                handler_method = getattr(cls, method_name)
                return handler_method(request, context,
                                      *args, **kwargs)
            else:
                # Our view doesn't want to handle this method; return
                # a 405
                return cls.method_not_acceptable(request)</pre>
</div>
<p>Our actual view code can then look a little something like this (minus
all the faff with input validation and authentication):</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">CheeseView</span><span class="p">(</span><span class="n">BaseView</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">initial_context</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">slug</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s">&#39;cheese&#39;</span><span class="p">:</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Cheese</span><span class="p">,</span> <span class="n">slug</span><span class="o">=</span><span class="n">slug</span><span class="p">)</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">handle_GET</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">slug</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;cheese_detail.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">handle_DELETE</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">slug</span><span class="p">):</span>
        <span class="n">context</span><span class="p">[</span><span class="s">&#39;cheese&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="c"># Return a 204 No Content response to acknowledge the cheese</span>
        <span class="c"># has gone.</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">204</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">handle_POST</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">slug</span><span class="p">):</span>
        <span class="c"># Allow a user to change the smelliness of the cheese</span>
        <span class="n">context</span><span class="p">[</span><span class="s">&#39;cheese&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">smelliness</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s">&#39;smelliness&#39;</span><span class="p">]</span>
        <span class="n">context</span><span class="p">[</span><span class="s">&#39;cheese&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">204</span><span class="p">)</span>
</pre></div>
</div>
<p>For those who aren’t familiar with metaclasses, I’ll give a brief description
of class creation in Python. First, the class statement executes all the code
in the class body, using the newly bound objects (mostly the methods) to
populate a dictionary. This dictionary is then passed to the __new__ method on
the metaclass, along with the name of the class and its base classes. Unless
otherwise specified, the metaclass will be type, but the __metaclass__
attribute is used to override this. The __new__ method can alter the name,
base classes and attribute dictionary as it sees fit. In our case we are
wrapping the functions in class method constructors so that they do not become
instance methods.</p>
<p>Other things we could do are:</p>
<blockquote>
<ul class="simple">
<li>Override handle_DELETE in a subclass to return a 403 Forbidden if the
cheese is important (calling super(cls, cls).handle_DELETE if it isn’t)</li>
<li>Despatch to other methods from a handler to keep our code looking
modular and tidy</li>
<li>Subclass __new__ to add more parameters to the handlers on subclasses</li>
</ul>
</blockquote>
<p>As an example of the last point, we have an OAuthView that ensures an access
token for a service and adds an urllib2 opener to the parameters which
contains the necessary credentials to access a remote resource.</p>
<p>The subclassing view can then simply call opener.open(url) without having to
worry about achieving the requisite authorisation.</p>
<p>Using class-based views allows us to define other methods on the views to
return metadata about the resource being requested. As an example, we have a
method that constructs the content for the breadcrumb trail, and another that
returns the metadata for displaying in search results.</p>
<p>Achieving such extensibility with function-based views would be nigh on
impossible.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <h3><a href="../index.html">Table Of Contents</a></h3>
            <ul>
<li><a class="reference external" href="#">Explaining Molly&#8217;s class-based views</a><ul>
<li><a class="reference external" href="#class-based-views-and-metaclasses">Class-based views and metaclasses</a></li>
</ul>
</li>
</ul>

            <h4>Previous topic</h4>
            <p class="topless"><a href="writing_an_application.html"
                                  title="previous chapter">Writing an application</a></p>
            <h4>Next topic</h4>
            <p class="topless"><a href="testing.html"
                                  title="next chapter">Testing</a></p>
            <h3>This Page</h3>
            <ul class="this-page-menu">
              <li><a href="../_sources/topics/class_based_views.txt"
                     rel="nofollow">Show Source</a></li>
            </ul>
          <div id="searchbox" style="display: none">
            <h3>Quick search</h3>
              <form class="search" action="../search.html" method="get">
                <input type="text" name="q" size="18" />
                <input type="submit" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
              </form>
              <p class="searchtip" style="font-size: 90%">
              Enter search terms or a module, class or function name.
              </p>
          </div>
          <script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../modindex.html" title="Global Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="testing.html" title="Testing"
             >next</a> |</li>
        <li class="right" >
          <a href="writing_an_application.html" title="Writing an application"
             >previous</a> |</li>
        <li><a href="../index.html">molly v0.3 documentation</a> &raquo;</li>
          <li><a href="index.html" >Implementation topics</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
      &copy; Copyright 2010, Molly Project and contributors.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 0.6.6.
    </div>
  </body>
</html>